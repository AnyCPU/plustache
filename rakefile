# rakefile for compiling plustache

require 'rake/clean'

# plustache files
SRC_FILES = FileList["src/template.cpp", "src/context.cpp"]
OBJ_FILES = FileList["build/*.o"]
# files for the executable
BIN_SRC = "src/main.cpp"
BIN_OBJ = "build/main.o"
# files for unit testing
TEST_SRC = FileList["tests/*.cpp"]
TEST_OBJ = FileList["tests/*.o"]
# include dirs
INCLUDE_DIRS = ["include", "/usr/local/homebrew/include"]
# executables
OUTFILE = "bin/plustache"
OUTFILE_TEST = "bin/plustache_tests"
# compiler/linker stuff
CC = "g++"
LD = "g++"
CCFLAGS = ["-O3","-wall", "-I #{INCLUDE_DIRS.join(" -I")}"]
LDFLAGS = ["-L/usr/local/homebrew/lib"]

task :default => [:link, :clean]

desc "compile the main sources"
directory "build"
task :compile => "build" do
  SRC_FILES.each do |src|
    object = File.basename(src, ".cpp") + ".o"
    sh "#{CC} #{CCFLAGS.join(" ")} -c #{src} -o build/#{object}"
  end
end

desc "link the object files together"
directory "bin"
task :link => [:compile_executable, "bin"] do
  sh "#{LD} -o #{OUTFILE} #{OBJ_FILES.join(" ")} #{LDFLAGS.join(" ")} \
-lboost_regex-mt"
end

desc "compile the sources for the executable"
directory "build"
task :compile_executable => [:compile, "build"] do
  sh "#{CC} #{CCFLAGS.join(" ")} -c #{BIN_SRC} -o #{BIN_OBJ}"
end

# unit testing tasks
desc "execute unit tests"
task :test => [:linktests] do
  sh "./#{OUTFILE_TEST}"
end

desc "compile sources for unit testing"
task :compiletests => [:compile] do
  TEST_SRC.each do |src|
    object = File.basename(src, ".cpp") + ".o"
    sh "#{CC} #{CCFLAGS.join(" ")} -c #{src} -o tests/#{object}"
  end
end

desc "link sources for unit testing"
directory "bin"
task :linktests => [:compiletests, "bin"] do
  sh "#{LD} -o #{OUTFILE_TEST} #{OBJ_FILES.join(" ")} \
#{TEST_OBJ.join(" ")} #{LDFLAGS.join(" ")} -lgtest -lboost_regex-mt"
end

# cleanup tasks
CLEAN.include("build", "tests/*.o")
CLOBBER.include("build", "bin", "tests/*.o")
